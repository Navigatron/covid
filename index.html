<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="A by-county map of Covid-19 in the US. No silly circles.">
	<title>Covid-19 by county</title>
	<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="https://d3js.org/queue.v1.min.js"></script>
	<script type="text/javascript" src="https://d3js.org/topojson.v1.min.js"></script>
</head>

<!-- CSS -->
<style>

	/* Map CSS */
	path {
	 	/* stroke:white;
	 	stroke-width: 1px; */
	}

	body {
	 	font-family: sans-serif;
	}

	.county {
	 	font: 14px sans-serif;
	 	font-weight: bold;
	}

	.legend {
	 	font-size: 14px;
	 	font-family: 'Proxima Nova', sans-serif;
	}

	.legend_title {
	 	font-size: 14px;
	 	font-family: 'Proxima Nova', sans-serif;
	 	font-weight: bold;
	}

	div.tooltip {
	 	position: absolute;
	 	left: 75px;
	 	text-align: center;
	 	height: 16px;
	 	padding: 10px;
	 	font-size: 14px;
	 	background: #FFFFFF;
	 	border: 1px solid #989898;
 		pointer-events: none;
	}

	@media (max-width: 400px) {
	    .d3map {
	        display: none;
	    }
	}

	/* Page CSS */

	body{
		margin: 0;
	}
	header{
		padding: 0 1rem;
		margin-bottom: 1rem;
		overflow: auto;
		/* box-shadow: 0px 0px 6px 0px #999; */
	}
	header h1{
		text-align: center;
	}
	.map{
		margin: 1rem 0;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	.map #map{

	}
	main{
		max-width: 600px;
		margin: 1rem auto;
		padding: 0 1rem;
	}
	footer{
		max-width: 500;
		margin: 1rem auto;
		padding: 0 1rem;
		text-align: center;
		font-size: 0.8rem;
	}
</style>

<body>
<header>
	<h1>COVID-19 in the U.S. by County</h1>
</header>
<section class="map">
	<div id="map">
	</div>
</section>
<main>
	<h1>COVID-19 Cases in the U.S. by County</h1>
	<p>
		Last (full) update: March 15th, 9PM
	</p>
	<p>
		Data is pulled directly from the department of health website for each state.
	</p>
	<p>
		Black regions have no data. There are 50 states and over 3000 counties - updating this can take a while.
	</p>
	<p>
		As of --03-17, 5PM, Maine has 7 cases not associated with a county.
	</p>
	<p>
		Data cannot be found for California. Detailed data cannot be found for Vermont. Detailed data cannot be found for Rhode Island.
	</p>
	<h2>Updates</h2>
	<p>
		The table below lists when I last checked for updates from each source, and when the data in each source is from.
	</p>
	<table>
		<tr>
			<th>State</th>
			<th>Last Check</th>
			<th>Data Age</th>
			<th>Source</th>
		</tr>
		<tr>
			<td>Connecticut</td>
			<td>--03-17 6PM</td>
			<td>--03-17 5PM</td>
			<td> <a href="https://portal.ct.gov/Coronavirus">portal.ct.gov/Coronavirus</a> </td>
		</tr>
		<tr>
			<td>Delaware</td>
			<td>--03-17 6PM</td>
			<td>--03-17 4PM</td>
			<td> <a href="https://dhss.delaware.gov/dhss/dph/epi/2019novelcoronavirus.html">dhss.delaware.gov</a> </td>
		</tr>
		<tr>
			<td>Maine</td>
			<td>--03-17 5PM</td>
			<td>--03-17 Noon</td>
			<td> <a href="https://www.maine.gov/dhhs/mecdc/infectious-disease/epi/airborne/coronavirus.shtml">www.maine.gov/dhhs</a> </td>
		</tr>
		<tr>
			<td>Maryland</td>
			<td>--03-17 7PM</td>
			<td>unknown</td>
			<td> <a href="https://coronavirus.maryland.gov">coronavirus.maryland.gov</a> </td>
		</tr>
		<tr>
			<td>Massachusetts</td>
			<td>--03-17 6PM</td>
			<td>--03-17 ???</td>
			<td> <a href="https://www.mass.gov/doc/covid-19-cases-in-massachusetts-as-of-march-17-2020/download">This PDF</a> </td>
		</tr>
		<tr>
			<td>New Hampshire</td>
			<td>--03-17 5PM</td>
			<td>--03-17 9AM</td>
			<td> <a href="https://www.nh.gov/covid19/">www.nh.gov/covid19</a> </td>
		</tr>
		<tr>
			<td>New Jersey</td>
			<td>--03-17 5PM</td>
			<td>--03-17 2PM</td>
			<td> <a href="https://www.nj.gov/health/cd/topics/covid2019_dashboard.shtml">www.nj.gov/health</a> </td>
		</tr>
		<tr>
			<td>New York</td>
			<td>--03-17 5PM</td>
			<td>--03-17 1PM</td>
			<td> <a href="https://coronavirus.health.ny.gov/county-county-breakdown-positive-cases">coronavirus.health.ny.gov</a> </td>
		</tr>
		<tr>
			<td>North Carolina</td>
			<td>--03-17 11PM</td>
			<td>--03-17 8AM</td>
			<td> <a href="https://www.ncdhhs.gov/covid-19-case-count-nc">www.ncdhhs.gov/covid-19-case-count-nc</a> </td>
		</tr>
		<tr>
			<td>Oregon</td>
			<td>--03-17 11PM</td>
			<td>--03-17 ???</td>
			<td> <a href="https://www.oregon.gov/oha/PH/DISEASESCONDITIONS/DISEASESAZ/Pages/emerging-respiratory-infections.aspx">www.oregon.gov</a> </td>
		</tr>
		<tr>
			<td>Pennsylvania</td>
			<td>--03-17 6PM</td>
			<td>--03-17 Noon</td>
			<td><a href="https://www.health.pa.gov/topics/disease/Pages/Coronavirus.aspx">www.health.pa.gov</a></td>
		</tr>
		<tr>
			<td>Virginia</td>
			<td>--03-17 11PM</td>
			<td>--03-17 ???</td>
			<td> <a href="http://www.vdh.virginia.gov/coronavirus/">www.vdh.virginia.gov/coronavirus</a> </td>
		</tr>
		<tr>
			<td>Washington</td>
			<td>--03-17 6PM</td>
			<td>--03-17 4PM</td>
			<td> <a href="https://www.doh.wa.gov/Emergencies/Coronavirus">www.doh.wa.gov</a> </td>
		</tr>
	</table>
</main>
<footer>
&copy; 2020 <a href="https://ewitherington.me">Ethan Witherington</a>
</footer>

<script type="text/javascript">
	// Variables
	var width = 960, height = 600;
	var color_domain = [1,2,11,101, 1001]; // This is post the +1 to account for log scale
	var ext_color_domain = [0,1,2,5,10,20,50,100,200,500, 1000]
	var legend_labels = ["0","1","2","5","10","20","50","100","200","500","1000"]

	// Color? Yessss this is fun to play with
	//var color = d3.scale.threshold()
	var color = d3.scale.log()
		.domain(color_domain)
		//.domain([1,2,20,400]) // max NYC 329
		//.range(["#dcdcdc", "#d0d6cd", "#bdc9be", "#aabdaf", "#97b0a0", "#84a491", "#719782", "#5e8b73", "#4b7e64", "#387255", "#256546", "#125937", "#004d28"]);
		.range([
			"#00FF00", // nobody = green
			"#FFFF00", //    1 = yellow
			"#FF0000", //   10 = red
			"#ff00ff", //  100 = purple
			"#0000FF"  // 1000 = blue
			]);

	// Creates the tooltop, transparent.
	var div = d3.select("body").append("div")
		.attr("class", "tooltip")
		.style("opacity", 0);

	// Create the svg
	var svg = d3.select("#map").append("svg")
		.attr("width", width)
		//.attr("max-width", "100%")
		.attr("viewBox", "0 0 "+width+" "+height)
		.attr("height", height)
		.style("max-width", "100%")
		.style("height", "100%")
		.style("margin", "0px auto");

	// It looks like this does the actual stuff.
	// Load all that data and then call the ready function
	var path = d3.geo.path()
		queue()
		.defer(d3.json, "us.json")
		.defer(d3.csv, "data.csv")
		.await(ready);

	function ready(error, us, data) {
		// Mappings of IDs to data about the IDs.
		var pairRateWithId = {};
		var pairNameWithId = {};

		//Moves selction to front
		d3.selection.prototype.moveToFront = function() {
			return this.each(
				function(){
					this.parentNode.appendChild(this);
				}
			);
		};

		//Moves selction to back
		d3.selection.prototype.moveToBack = function() {
			return this.each(function() {
				var firstChild = this.parentNode.firstChild;
				if (firstChild) {
					this.parentNode.insertBefore(this, firstChild);
				}
			});
		};

		// This looks important
		// For each key in the data, which is... the csv data?
		data.forEach(function(d) {
			pairRateWithId[d.id] = +d.rate;
			// IDs are given a rate variable
			pairNameWithId[d.id] = d.name;
			// IDs are given a *name* variable
		});

		// Create the SVG
		svg.append("g")
			.attr("class", "county") // svg.class = county
			.selectAll("path")
			.data(topojson.feature(us, us.objects.counties).features) // put in counties
			.enter().append("path")
			.attr("d", path)
			.style ( "fill" , function (d) {
				return color (pairRateWithId[d.id]+1); // convert the ID's rate to a color. Color is a function that takes a number and returns a color
				// Plus 1 is in there to counter the log limitation of all values positive
			})
			//.style("opacity", 0.8) // commented to make more dark
			// .on("mouseover", function(d) { // This creates the hover dialog // commented to make faster
			// 	var sel = d3.select(this);
			// 	sel.moveToFront();
			// 	d3.select(this).transition().duration(300).style({'opacity': 1, 'stroke': 'black', 'stroke-width': 1.5});
			// 	div.transition().duration(300)
			// 	.style("opacity", 1)
			// 	div.text(d.id + ": " + pairNameWithId[d.id] + ": " + pairRateWithId[d.id])
			// 	.style("left", (d3.event.pageX) + "px")
			// 	.style("top", (d3.event.pageY -30) + "px");
			// })
			// .on("mouseout", function() { // Remove the hover dialog
			// 	var sel = d3.select(this);
			// 	sel.moveToBack();
			// 	d3.select(this)
			// 	.transition().duration(300)
			// 	.style({'opacity': 0.8, 'stroke': 'white', 'stroke-width': 1});
			// 	div.transition().duration(300)
			// 	.style("opacity", 0);
			// })

	};

	// The Legend
	var legend = svg.selectAll("g.legend")
		.data(ext_color_domain)
		.enter().append("g")
		.attr("class", "legend");

	// Evil Magic Numbers What do they MEAN
	// Legend Sample Width and Legend Sample Height
	var ls_w = width/legend_labels.length;
	var ls_h = 20;

	// Legend Rectangles
	legend.append("rect")
		//.attr("x", function(d, i){ return width - (i*ls_w) - ls_w;})
		.attr("x", function(d, i){ return (i*ls_w);})
		.attr("y", 550)
		.attr("width", ls_w)
		.attr("height", ls_h)
		.style("fill", function(d, i) { return color(d+1); })
		.style("opacity", 0.8);

	// Legend Text
	legend.append("text")
		//.attr("x", function(d, i){ return width - (i*ls_w) - ls_w;})
		.attr("x", function(d, i){ return (i*ls_w);})
		.attr("y", 590)
		.text(function(d, i){ return legend_labels[i]; });

	// Leged Title? Coolio.
	var legend_title = "Covid19 Cases";

	// Slap the text onto the legend
	svg.append("text")
		.attr("x", 10)
		.attr("y", 540)
		.attr("class", "legend_title")
		.text(function(){return legend_title});

</script>
</body>

</html>
